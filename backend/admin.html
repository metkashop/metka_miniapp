<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>METKA SHOP ‚Äî –ê–¥–º–∏–Ω–∫–∞</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #1a1a1a; color: #e0e0e0; }
  .header { background: #111; padding: 16px 24px; border-bottom: 1px solid #333; }
  .header h1 { font-size: 18px; color: #fff; }
  .tabs { display: flex; border-bottom: 1px solid #333; background: #111; }
  .tab { padding: 12px 24px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; font-size: 14px; }
  .tab.active { color: #fff; border-bottom-color: #5b9cf6; }
  .content { padding: 24px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; color: #888; font-weight: 500; border-bottom: 1px solid #333; white-space: nowrap; }
  td { padding: 10px 12px; border-bottom: 1px solid #2a2a2a; vertical-align: middle; }
  tr.order-main:hover td { background: #222; cursor: pointer; }
  .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .badge-new { background: #1a3a5c; color: #5b9cf6; }
  .badge-processing { background: #3a2a1a; color: #ffaa44; }
  .badge-shipped { background: #1a3a2a; color: #44cc88; }
  .badge-done { background: #2a2a2a; color: #888; }
  .badge-cancelled { background: #3a1a1a; color: #e24a4a; }
  .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap; }
  .btn-primary { background: #5b9cf6; color: #fff; }
  .btn-danger { background: #e24a4a; color: #fff; }
  .btn-ghost { background: #2a2a2a; color: #ccc; }
  .btn-warn { background: #ffaa44; color: #111; }
  .btn:hover { opacity: 0.85; }
  .btn-block { display: block; width: 100%; margin-bottom: 6px; text-align: center; }
  .detail-row { display: none; }
  .detail-row.open { display: table-row; }
  .detail-box { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; margin: 4px 0 8px; overflow: hidden; }
  .col-label { font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600; }
  .field-label { font-size: 11px; color: #666; margin-bottom: 2px; }
  .field-value { font-size: 13px; color: #e0e0e0; margin-bottom: 8px; }
  .field-value a { color: #5b9cf6; text-decoration: none; }
  .order-item-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 6px 0; border-bottom: 1px solid #2a2a2a; font-size: 12px; }
  .order-item-row:last-child { border-bottom: none; }
  .item-name { color: #ccc; }
  .item-detail { color: #888; font-size: 11px; }
  .item-price { color: #fff; font-weight: 500; text-align: right; white-space: nowrap; }
  .calc-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; color: #888; }
  .calc-row.total { color: #fff; font-weight: 600; font-size: 14px; border-top: 1px solid #333; padding-top: 8px; margin-top: 4px; }
  .calc-row.promo { color: #44cc88; }
  .detail-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #161616; border-top: 1px solid #2a2a2a; }
  .detail-footer-right { display: flex; gap: 8px; }
  select.status-select { background: #2a2a2a; color: #ccc; border: 1px solid #444; border-radius: 4px; padding: 5px 8px; font-size: 12px; width: 100%; margin-bottom: 8px; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; }
  .modal.open { display: flex; }
  .modal-box { background: #222; border: 1px solid #444; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; }
  .modal-box h3 { margin-bottom: 12px; }
  .modal-box p { color: #888; font-size: 13px; margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .empty { text-align: center; color: #555; padding: 40px; }
  input[type=text], input[type=number], input[type=date] { background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 13px; width: 100%; }
  select.form-select { background: #2a2a2a; color: #ccc; border: 1px solid #444; border-radius: 6px; padding: 8px 12px; font-size: 13px; width: 100%; }
  .field label { font-size: 12px; color: #888; display: block; margin-bottom: 4px; }
  .form-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
  hr.divider { border: none; border-top: 1px solid #2a2a2a; margin: 8px 0; }
</style>
</head>
<body>

<div class="header"><h1>‚ö° METKA SHOP ‚Äî –ê–¥–º–∏–Ω–∫–∞</h1></div>

<div class="tabs">
  <div class="tab active" onclick="showTab('orders')">–ó–∞–∫–∞–∑—ã</div>
  <div class="tab" onclick="showTab('products')">–¢–æ–≤–∞—Ä—ã</div>
  <div class="tab" onclick="showTab('promos')">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
</div>

<div class="content">

  <div id="tab-orders">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <span style="color:#888;font-size:13px;" id="orders-count"></span>
      <button class="btn btn-ghost" onclick="loadOrders()">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <table>
      <thead>
        <tr><th>#</th><th>–î–∞—Ç–∞</th><th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>

  <div id="tab-products" style="display:none">
    <div style="margin-bottom:16px;">
      <button class="btn btn-primary" onclick="document.getElementById('add-product-form').style.display=''">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    </div>
    <div id="add-product-form" style="display:none" class="form-card">
      <h3 style="margin-bottom:12px;">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div class="field"><label>–ê—Ä—Ç–∏–∫—É–ª</label><input type="text" id="p-art"></div>
        <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="p-name"></div>
        <div class="field"><label>–¶–µ–Ω–∞</label><input type="number" id="p-price" min="0"></div>
        <div class="field"><label>–¶–≤–µ—Ç</label><input type="text" id="p-color"></div>
        <div class="field"><label>–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" id="p-sizes" value="XS,S,M,L,XL,XXL,3XL"></div>
        <div class="field"><label>–ö–∞—Ä—Ç–∏–Ω–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" id="p-images"></div>
      </div>
      <div class="field" style="margin-bottom:12px;"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="p-desc"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" onclick="addProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-ghost" onclick="document.getElementById('add-product-form').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    <table>
      <thead><tr><th>–ê—Ä—Ç</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–†–∞–∑–º–µ—Ä—ã</th><th></th></tr></thead>
      <tbody id="products-body"></tbody>
    </table>
  </div>

  <div id="tab-promos" style="display:none">
    <div class="form-card">
      <h3 style="margin-bottom:12px;">–ù–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
        <div class="field"><label>–ö–æ–¥</label><input type="text" id="promo-code" placeholder="SALE10"></div>
        <div class="field"><label>–¢–∏–ø —Å–∫–∏–¥–∫–∏</label><select id="promo-type" class="form-select"><option value="percent">% –æ—Ç —Å—É–º–º—ã</option><option value="fixed">–§–∏–∫—Å. —Å—É–º–º–∞ (‚ÇΩ)</option></select></div>
        <div class="field"><label>–†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏</label><input type="number" id="promo-discount" placeholder="10" min="1"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">
        <div class="field"><label>–î–µ–π—Å—Ç–≤—É–µ—Ç —Å</label><input type="date" id="promo-from"></div>
        <div class="field"><label>–î–µ–π—Å—Ç–≤—É–µ—Ç –ø–æ</label><input type="date" id="promo-to"></div>
        <div class="field"><label>–ú–∞–∫—Å. —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π (–ø—É—Å—Ç–æ = ‚àû)</label><input type="number" id="promo-maxuses" placeholder="‚àû" min="1"></div>
      </div>
      <button class="btn btn-primary" onclick="addPromo()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
    </div>
    <table>
      <thead><tr><th>–ö–æ–¥</th><th>–¢–∏–ø</th><th>–°–∫–∏–¥–∫–∞</th><th>–ü–µ—Ä–∏–æ–¥</th><th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th></th></tr></thead>
      <tbody id="promos-body"></tbody>
    </table>
  </div>

</div>

<div class="modal" id="modal-delete-order">
  <div class="modal-box">
    <h3>–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?</h3>
    <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é.</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-delete-order')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="confirmDeleteOrder()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>
<div class="modal" id="modal-delete-personal">
  <div class="modal-box">
    <h3>–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?</h3>
    <p>–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å –í–ö –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –ó–∞–∫–∞–∑ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-delete-personal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-warn" onclick="confirmDeletePersonal()">–£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>
</div>

<script>
const API = 'http://localhost:3001'
let pendingOrderId = null
const statusLabels = { new:'–ù–æ–≤—ã–π', processing:'–í –æ–±—Ä–∞–±–æ—Ç–∫–µ', shipped:'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω', done:'–í—ã–ø–æ–ª–Ω–µ–Ω', cancelled:'–û—Ç–º–µ–Ω—ë–Ω' }
const statusClass = { new:'badge-new', processing:'badge-processing', shipped:'badge-shipped', done:'badge-done', cancelled:'badge-cancelled' }

function showTab(tab) {
  ['orders','products','promos'].forEach((t,i) => {
    document.getElementById('tab-'+t).style.display = t===tab ? '' : 'none'
    document.querySelectorAll('.tab')[i].classList.toggle('active', t===tab)
  })
  if (tab==='orders') loadOrders()
  if (tab==='products') loadProducts()
  if (tab==='promos') loadPromos()
}

async function loadOrders() {
  const res = await fetch(API+'/api/orders')
  const orders = await res.json()
  document.getElementById('orders-count').textContent = '–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: '+orders.length
  const tbody = document.getElementById('orders-body')
  tbody.innerHTML = ''
  if (!orders.length) { tbody.innerHTML='<tr><td colspan="7" class="empty">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>'; return }

  orders.slice().reverse().forEach(order => {
    const items = JSON.parse(order.items || '[]')
    const date = new Date(order.created_at).toLocaleString('ru')
    const status = order.status || 'new'
    const name = order.name || '‚Äî'
    const vkLink = order.vk_id
      ? '<a href="https://vk.com/id'+order.vk_id+'" target="_blank" style="color:#5b9cf6">'+name+'</a>'
      : name

    const mainRow = document.createElement('tr')
    mainRow.className = 'order-main'
    mainRow.onclick = () => toggleDetail(order.id)
    mainRow.innerHTML =
      '<td>'+order.id+'</td>'+
      '<td style="white-space:nowrap">'+date+'</td>'+
      '<td>'+vkLink+'</td>'+
      '<td>'+(order.phone||'‚Äî')+'</td>'+
      '<td style="white-space:nowrap;font-weight:600">'+order.total+' ‚ÇΩ</td>'+
      '<td><span class="badge '+statusClass[status]+'">'+statusLabels[status]+'</span></td>'+
      '<td style="color:#555">‚ñº</td>'
    tbody.appendChild(mainRow)

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã
    const grouped = {}
    items.forEach(function(i) {
      const key = i.art+'_'+i.size
      if (!grouped[key]) grouped[key] = { name:i.name, art:i.art, size:i.size, price:i.price, qty:0, total:0 }
      grouped[key].qty++
      grouped[key].total += i.price
    })
    let itemsHtml = ''
    Object.values(grouped).forEach(function(i) {
      itemsHtml +=
        '<div class="order-item-row">'+
          '<div><div class="item-name">'+i.name+'</div><div class="item-detail">–ê—Ä—Ç: '+i.art+' ¬∑ –†–∞–∑–º–µ—Ä: '+i.size+'</div></div>'+
          '<div class="item-price">'+i.qty+' √ó '+i.price+' ‚ÇΩ = '+i.total+' ‚ÇΩ</div>'+
        '</div>'
    })

    // –†–∞—Å—á—ë—Ç
    const subtotal = items.reduce(function(s,i){ return s+i.price }, 0)
    const hasPromo = order.promo_code && order.promo_code !== 'null' && order.promo_code !== ''
    const promoDiscount = hasPromo
      ? (order.promo_discount ? Math.round(subtotal * order.promo_discount / 100) : (order.promo_fixed || 0))
      : 0
    const delivery = order.delivery_cost || 0

    let calcHtml = '<div class="calc-row"><span>–¢–æ–≤–∞—Ä—ã ('+items.length+' —à—Ç.)</span><span>'+subtotal+' ‚ÇΩ</span></div>'
    if (hasPromo) {
      calcHtml += '<div class="calc-row promo"><span>üè∑ '+order.promo_code+'</span><span>‚àí'+promoDiscount+' ‚ÇΩ</span></div>'
    }
    if (delivery) {
      calcHtml += '<div class="calc-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞</span><span>'+delivery+' ‚ÇΩ</span></div>'
    } else {
      calcHtml += '<div class="calc-row"><span>–î–æ—Å—Ç–∞–≤–∫–∞</span><span style="color:#555">–Ω–µ —É–∫–∞–∑–∞–Ω–∞</span></div>'
    }
    calcHtml += '<div class="calc-row total"><span>–ò—Ç–æ–≥–æ</span><span>'+order.total+' ‚ÇΩ</span></div>'

    // –ö–Ω–æ–ø–∫–∞ –Ω–∞–ø–∏—Å–∞—Ç—å
    const msgBtn = order.vk_id
      ? '<button class="btn btn-ghost" style="padding:3px 7px;font-size:14px;line-height:1" title="–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—é" onclick="event.stopPropagation();window.open(\'https://vk.com/im?sel='+order.vk_id+'\',\'_blank\')">‚úâÔ∏è</button>'
      : ''

    const detailRow = document.createElement('tr')
    detailRow.className = 'detail-row'
    detailRow.id = 'detail-'+order.id

    const html =
      '<td colspan="7" style="padding:0 0 4px 0">'+
      '<div class="detail-box">'+
        '<div style="display:grid;grid-template-columns:1fr 2fr 1fr 0.5fr;min-height:200px">'+

          // –ö–æ–ª–æ–Ω–∫–∞ 1: –ø–æ–∫—É–ø–∞—Ç–µ–ª—å + –¥–æ—Å—Ç–∞–≤–∫–∞
          '<div style="border-right:1px solid #2a2a2a;display:flex;flex-direction:column">'+
            '<div style="padding:14px;border-bottom:1px solid #2a2a2a;flex:1">'+
              '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'+
                '<div class="col-label" style="margin-bottom:0">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</div>'+
                msgBtn+
              '</div>'+
              '<div class="field-label">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</div><div class="field-value">'+date+'</div>'+
              '<div class="field-label">–§–ò–û</div><div class="field-value">'+vkLink+'</div>'+
              '<div class="field-label">–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="field-value">'+(order.phone||'‚Äî')+'</div>'+
              '<div class="field-label">VK ID</div><div class="field-value">'+(order.vk_id ? '<a href="https://vk.com/id'+order.vk_id+'" target="_blank">'+order.vk_id+'</a>' : '‚Äî')+'</div>'+
            '</div>'+
            '<div style="padding:14px">'+
              '<div class="col-label">–î–æ—Å—Ç–∞–≤–∫–∞</div>'+
              '<div class="field-label">–ì–æ—Ä–æ–¥</div><div class="field-value">'+(order.delivery_city||'‚Äî')+'</div>'+
              '<div class="field-label">–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</div><div class="field-value">'+(order.delivery_pvz||'‚Äî')+'</div>'+
              '<div class="field-label">–¢–∞—Ä–∏—Ñ</div><div class="field-value">'+(order.delivery_type||'‚Äî')+'</div>'+
            '</div>'+
          '</div>'+

          // –ö–æ–ª–æ–Ω–∫–∞ 2: —Å–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
          '<div style="padding:14px;border-right:1px solid #2a2a2a">'+
            '<div class="col-label">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</div>'+
            itemsHtml+
          '</div>'+

          // –ö–æ–ª–æ–Ω–∫–∞ 3: —Ä–∞—Å—á—ë—Ç
          '<div style="padding:14px;border-right:1px solid #2a2a2a">'+
            '<div class="col-label">–†–∞—Å—á—ë—Ç</div>'+
            calcHtml+
          '</div>'+

          // –ö–æ–ª–æ–Ω–∫–∞ 4: —Å—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫–∏
          '<div style="padding:14px">'+
            '<div class="col-label">–î–µ–π—Å—Ç–≤–∏—è</div>'+
            '<div class="field-label" style="margin-bottom:4px">–°—Ç–∞—Ç—É—Å</div>'+
            '<select class="status-select" id="status-select-'+order.id+'">'+
              Object.entries(statusLabels).map(function(e){ return '<option value="'+e[0]+'"'+(status===e[0]?' selected':'')+'>'+e[1]+'</option>' }).join('')+
            '</select>'+
            '<button class="btn btn-primary btn-block" onclick="updateStatus('+order.id+')">‚úì –û–±–Ω–æ–≤–∏—Ç—å</button>'+
            '<hr class="divider">'+
            '<button class="btn btn-ghost btn-block" onclick="alert(\'–°–î–≠–ö ‚Äî —Å–∫–æ—Ä–æ!\')">üì¶ –í –°–î–≠–ö</button>'+
            '<button class="btn btn-ghost btn-block" onclick="alert(\'–°–î–≠–ö ‚Äî —Å–∫–æ—Ä–æ!\')">üñ® –ù–∞–∫–ª–∞–¥–Ω–∞—è</button>'+
            '<button class="btn btn-ghost btn-block" onclick="alert(\'–°–î–≠–ö ‚Äî —Å–∫–æ—Ä–æ!\')">üè∑ –≠—Ç–∏–∫–µ—Ç–∫–∞</button>'+
          '</div>'+

        '</div>'+
        '<div class="detail-footer">'+
          '<span style="color:#555;font-size:12px">–ó–∞–∫–∞–∑ #'+order.id+'</span>'+
          '<div class="detail-footer-right">'+
            '<button class="btn btn-warn" onclick="deletePersonal('+order.id+')">üóë –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–¥–∞–Ω–Ω—ã–µ</button>'+
            '<button class="btn btn-danger" onclick="deleteOrder('+order.id+')">‚úï –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑</button>'+
          '</div>'+
        '</div>'+
      '</div></td>'

    detailRow.innerHTML = html
    tbody.appendChild(detailRow)
  })
}

function toggleDetail(id) { document.getElementById('detail-'+id).classList.toggle('open') }

async function updateStatus(id) {
  const status = document.getElementById('status-select-'+id).value
  await fetch(API+'/api/orders/'+id+'/status', { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({status}) })
  loadOrders()
}

function deleteOrder(id) { pendingOrderId=id; document.getElementById('modal-delete-order').classList.add('open') }
async function confirmDeleteOrder() {
  await fetch(API+'/api/orders/'+pendingOrderId, { method:'DELETE' })
  closeModal('modal-delete-order'); loadOrders()
}
function deletePersonal(id) { pendingOrderId=id; document.getElementById('modal-delete-personal').classList.add('open') }
async function confirmDeletePersonal() {
  await fetch(API+'/api/orders/'+pendingOrderId+'/personal', { method:'DELETE' })
  closeModal('modal-delete-personal'); loadOrders()
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); pendingOrderId=null }

async function loadProducts() {
  const res = await fetch(API+'/api/products')
  const products = await res.json()
  const tbody = document.getElementById('products-body')
  tbody.innerHTML = ''
  products.forEach(function(p) {
    const tr = document.createElement('tr')
    tr.innerHTML = '<td>'+p.art+'</td><td>'+p.name+'</td><td>'+p.price+' ‚ÇΩ</td><td style="font-size:11px;color:#888">'+p.sizes+'</td><td><button class="btn btn-danger" onclick="deleteProduct('+p.id+')">‚úï</button></td>'
    tbody.appendChild(tr)
  })
}

async function addProduct() {
  const body = {
    art: document.getElementById('p-art').value,
    name: document.getElementById('p-name').value,
    price: +document.getElementById('p-price').value,
    description: document.getElementById('p-desc').value,
    images: document.getElementById('p-images').value,
    sizes: document.getElementById('p-sizes').value,
    color: document.getElementById('p-color').value
  }
  await fetch(API+'/api/products', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) })
  document.getElementById('add-product-form').style.display='none'
  loadProducts()
}

async function deleteProduct(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return
  await fetch(API+'/api/products/'+id, { method:'DELETE' })
  loadProducts()
}

async function loadPromos() {
  const res = await fetch(API+'/api/promocodes')
  const promos = await res.json()
  const tbody = document.getElementById('promos-body')
  tbody.innerHTML = ''
  if (!promos.length) { tbody.innerHTML='<tr><td colspan="7" class="empty">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</td></tr>'; return }
  promos.forEach(function(p) {
    const typeLabel = p.type==='fixed' ? p.discount+' ‚ÇΩ' : p.discount+'%'
    const from = p.valid_from ? new Date(p.valid_from).toLocaleDateString('ru') : '‚àû'
    const to = p.valid_to ? new Date(p.valid_to).toLocaleDateString('ru') : '‚àû'
    const uses = p.max_uses ? (p.used_count||0)+' / '+p.max_uses : (p.used_count||0)+' / ‚àû'
    const tr = document.createElement('tr')
    tr.innerHTML =
      '<td><strong>'+p.code+'</strong></td>'+
      '<td>'+(p.type==='fixed'?'–§–∏–∫—Å.':'%')+'</td>'+
      '<td>'+typeLabel+'</td>'+
      '<td style="font-size:12px;color:#888">'+from+' ‚Äî '+to+'</td>'+
      '<td style="font-size:12px">'+uses+'</td>'+
      '<td>'+(p.active?'‚úÖ':'‚ùå')+'</td>'+
      '<td><button class="btn btn-danger" onclick="deletePromo('+p.id+')">‚úï</button></td>'
    tbody.appendChild(tr)
  })
}

async function addPromo() {
  const code = document.getElementById('promo-code').value.trim().toUpperCase()
  const discount = Math.abs(+document.getElementById('promo-discount').value)
  const type = document.getElementById('promo-type').value
  const maxUsesVal = document.getElementById('promo-maxuses').value
  const max_uses = maxUsesVal ? Math.abs(+maxUsesVal) : null
  const valid_from = document.getElementById('promo-from').value || null
  const valid_to = document.getElementById('promo-to').value || null
  if (!code || !discount) return
  await fetch(API+'/api/promocodes', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({code,discount,type,max_uses,valid_from,valid_to})
  })
  document.getElementById('promo-code').value=''
  document.getElementById('promo-discount').value=''
  document.getElementById('promo-maxuses').value=''
  document.getElementById('promo-from').value=''
  document.getElementById('promo-to').value=''
  loadPromos()
}

async function deletePromo(id) {
  await fetch(API+'/api/promocodes/'+id, { method:'DELETE' })
  loadPromos()
}

loadOrders()
</script>
</body>
</html>
